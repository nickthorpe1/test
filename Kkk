// Get alerts from AlertEvidence
let alertEvidence = AlertEvidence
| where Timestamp >= ago(7d) and isnotempty(SHA256) and isnotempty(ThreatFamily)
| project SHA256, FileName, IntroductionMethod, Timestamp, ThreatFamily, Severity, Count = 1;

// Get email events
let emailEvents = EmailEvents
| where Timestamp >= ago(7d) and isnotempty(SenderFromAddress) and isnotempty(RecipientEmailAddress)
| summarize make_list(SenderFromAddress), make_list(RecipientEmailAddress) by SHA256
| project SHA256, SenderFromAddress = tostring(list_SenderFromAddress[0]), RecipientEmailAddress = tostring(list_RecipientEmailAddress[0]);

// Get email attachments
let emailAttachments = EmailAttachments
| where Timestamp >= ago(7d) and isnotempty(SHA256)
| summarize make_list(FileName) by SHA256
| project SHA256, FileName = tostring(list_FileName[0]);

// Get device events
let deviceEvents = DeviceEvents
| where Timestamp >= ago(7d) and isnotempty(AttackTechniques)
| summarize make_list(AttackTechniques) by SHA256
| project SHA256, AttackTechniques = tostring(list_AttackTechniques[0]);

// Join all data
alertEvidence
| join kind=fullouter (emailEvents) on SHA256
| join kind=fullouter (emailAttachments) on SHA256
| join kind=fullouter (deviceEvents) on SHA256
| summarize 
    FileName = max(FileName), 
    IntroductionMethod = max(IntroductionMethod), 
    SenderFromAddress = max(SenderFromAddress), 
    RecipientEmailAddress = max(RecipientEmailAddress), 
    Timestamp = max(Timestamp), 
    ThreatFamily = max(ThreatFamily), 
    AttackTechniques = max(AttackTechniques), 
    Severity = max(Severity), 
    Count = count() 
by SHA256
| order by Count desc
| project SHA256, FileName, IntroductionMethod, SenderFromAddress, RecipientEmailAddress, Timestamp, ThreatFamily, AttackTechniques, Severity, Count;
