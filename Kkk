// Get alerts from AlertEvidence
let alertEvidence = AlertEvidence
| where Timestamp >= ago(7d) and isnotempty(SHA256) and isnotempty(ThreatFamily)
| project SHA256, FileName, IntroductionMethod, Timestamp, ThreatFamily, Severity, Count = 1;

// Get email events
let emailEvents = EmailEvents
| where Timestamp >= ago(7d) and isnotempty(SenderFromAddress) and isnotempty(RecipientEmailAddress)
| project EmailEventTimestamp = Timestamp, SenderFromAddress, RecipientEmailAddress;

// Get email attachments
let emailAttachments = EmailAttachments
| where Timestamp >= ago(7d) and isnotempty(SHA256)
| project SHA256, FileName, AttachmentTimestamp = Timestamp;

// Get device events
let deviceEvents = DeviceEvents
| where Timestamp >= ago(7d) and isnotempty(AttackTechniques)
| project SHA256, AttackTechniques, DeviceEventTimestamp = Timestamp;

// Join alertEvidence with emailEvents on Timestamp
let alertWithEmail = alertEvidence
| join kind=leftouter (emailEvents) on $left.Timestamp == $right.EmailEventTimestamp
| project SHA256, FileName, IntroductionMethod, Timestamp, ThreatFamily, Severity, SenderFromAddress, RecipientEmailAddress, Count;

// Join the result with emailAttachments on SHA256
let alertWithEmailAndAttachments = alertWithEmail
| join kind=leftouter (emailAttachments) on SHA256
| project SHA256, FileName, IntroductionMethod, Timestamp, ThreatFamily, Severity, SenderFromAddress, RecipientEmailAddress, AttachmentTimestamp, Count;

// Join the result with deviceEvents on SHA256
let completeData = alertWithEmailAndAttachments
| join kind=leftouter (deviceEvents) on SHA256
| project SHA256, FileName, IntroductionMethod, SenderFromAddress, RecipientEmailAddress, Timestamp, ThreatFamily, AttackTechniques, Severity, Count;

// Summarize and project final result
completeData
| summarize 
    FileName = max(FileName), 
    IntroductionMethod = max(IntroductionMethod), 
    SenderFromAddress = max(SenderFromAddress), 
    RecipientEmailAddress = max(RecipientEmailAddress), 
    Timestamp = max(Timestamp), 
    ThreatFamily = max(ThreatFamily), 
    AttackTechniques = max(AttackTechniques), 
    Severity = max(Severity), 
    Count = count() 
by SHA256
| order by Count desc
| project SHA256, FileName, IntroductionMethod, SenderFromAddress, RecipientEmailAddress, Timestamp, ThreatFamily, AttackTechniques, Severity, Count;
